- hosts: localhost
  roles:
  - role: standard-test-basic
    tags:
      - classic
    required_packages:
      - rust
      - cargo
      - binutils
      # the requirements below are for the integration suite
      - cmake
      - llvm-devel
      - clang
      - clang-analyzer
      - clang-tools-extra
      - compiler-rt
      - ninja-build
      - libcxx-devel
      - libomp-devel
      - python-lit
      - lld
      - lldb
      - git
      - make
    tests:
      - rust-sanity:
          dir: ./
          run: cargo new hello && cd hello && cargo run
      # There is a bug in the build process when it runs out of disk space
      # while stripping binaries, which causes the strip to fail, but does
      # not fail the build.  This results in a libLLVM.so that is over 2GB
      # which breaks the nightly compose.  So this test checks that libLLVM.so
      # is less than 100MB to ensure it was successfully stripped.
      # https://bugzilla.redhat.com/show_bug.cgi?id=1793250
      - libllvm-size:
          dir: ./
          run: test `stat -L -c %s /usr/lib64/libLLVM.so` -lt 100000000
      # This test ensures that the spec file still builds correctly with
      # %global compat_build 1
      # FIXME: This fails, because the CI system has a hard-coded timeout of 4
      # hours.
      #- build-compat
      - binutils-plugin-ar
      # make sure llvm-config symlink is properly setup
      - llvm-config:
          dir: ./
          run: llvm-config --version
      - integration-test-suite
